<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSO Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="auth-card">
            <div class="auth-header">
                <img src="c:\Users\kangd\OneDrive - ë¶€ì‚°ê´‘ì—­ì‹œêµìœ¡ì²­\ë°”íƒ• í™”ë©´\ë‚´ ëª…í•¨\ìŒ¤ê³µë¡œê³  í¸ì§‘ë³¸.png" alt="ë¡œê³ " class="auth-logo">
                <h1>SSO Dashboard</h1>
                <p>í†µí•© ì¸ì¦ ê´€ë¦¬</p>
            </div>
            
            <div class="dashboard">
                <div class="user-info">
                    <h3>ì‚¬ìš©ì ì •ë³´</h3>
                    <p><strong>ì´ë©”ì¼:</strong> <span id="userEmail">-</span></p>
                    <p><strong>ì´ë¦„:</strong> <span id="userName">-</span></p>
                    <p><strong>ID:</strong> <span id="userId">-</span></p>
                    <p><strong>ë¡œê·¸ì¸ ì‹œê°„:</strong> <span id="loginTime">-</span></p>
                    
                    <div class="token-info">
                        <strong>Access Token (ì¼ë¶€):</strong>
                        <div id="tokenPreview">-</div>
                    </div>
                </div>
                
                <div style="margin-top: 24px;">
                    <button id="logoutBtn" class="btn btn-primary">ë¡œê·¸ì•„ì›ƒ</button>
                    <button id="logoutAllBtn" class="btn btn-secondary" style="margin-top: 12px;">ëª¨ë“  ê¸°ê¸°ì—ì„œ ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>
        
        <div class="service-links">
            <h3>ì—°ë™ëœ ì„œë¹„ìŠ¤ë¡œ ì´ë™</h3>
            <p style="color: #6B7280; font-size: 14px; margin-bottom: 16px;">
                ì•„ë˜ ì„œë¹„ìŠ¤ë“¤ì€ ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤
            </p>
            <div class="service-grid">
                <!-- AI í€´ì¦ˆ ì„œë¹„ìŠ¤ ë§í¬ - ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                <a href="#" id="quizServiceLink" class="service-link">
                    <div class="service-icon">ğŸ¯</div>
                    <span>AI í€´ì¦ˆ</span>
                </a>
                <a href="#" id="service2Link" class="service-link">
                    <div class="service-icon">ğŸ’¼</div>
                    <span>ì„œë¹„ìŠ¤ 2</span>
                </a>
                <a href="#" id="service3Link" class="service-link">
                    <div class="service-icon">ğŸ®</div>
                    <span>ì„œë¹„ìŠ¤ 3</span>
                </a>
            </div>
            
            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #E5E7EB;">
                <h4 style="margin-bottom: 12px;">í™œì„± ì„¸ì…˜</h4>
                <div id="activeSessions">
                    <p style="color: #6B7280; font-size: 14px;">ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        import config from '../shared/config.js';
        
        const supabase = createClient(config.supabase.url, config.supabase.anonKey);
        
        // Quiz ì„œë¹„ìŠ¤ URL ì„¤ì • (ê°œë°œ/ìš´ì˜ í™˜ê²½ êµ¬ë¶„)
        const QUIZ_SERVICE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:8000'  // quiz ì‚¬ì´íŠ¸ê°€ ì‹¤í–‰ë˜ëŠ” í¬íŠ¸
            : 'https://quiz-liart-ten.vercel.app';  // Vercel ë°°í¬ URL
        
        // Check authentication
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'index.html';
                return;
            }
            
            // Display user info
            const user = session.user;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userName').textContent = user.user_metadata?.name || user.email.split('@')[0];
            document.getElementById('userId').textContent = user.id;
            document.getElementById('loginTime').textContent = new Date(session.created_at).toLocaleString('ko-KR');
            
            // Display token preview
            const token = localStorage.getItem(config.sso.tokenKey);
            if (token) {
                document.getElementById('tokenPreview').textContent = token.substring(0, 50) + '...';
            }
            
            // SSO ë§í¬ ì„¤ì •
            setupSSOLinks(user, token || session.access_token);
            
            // Update active sessions
            updateActiveSessions();
        }
        
        // SSO ë§í¬ ì„¤ì • í•¨ìˆ˜
        function setupSSOLinks(user, token) {
            // ì‚¬ìš©ì ì •ë³´ ì¤€ë¹„
            const userData = {
                id: user.id,
                email: user.email,
                name: user.user_metadata?.name || user.email.split('@')[0],
                accountType: user.user_metadata?.accountType || 'student',
                role: user.user_metadata?.role || 'user'
            };
            
            // Base64 ì¸ì½”ë”© (í•œê¸€ ì²˜ë¦¬)
            const encodedUser = btoa(encodeURIComponent(JSON.stringify(userData)));
            
            // Quiz ì„œë¹„ìŠ¤ ë§í¬ ì„¤ì • - explore.htmlë¡œ ì§ì ‘ ì´ë™
            const quizLink = document.getElementById('quizServiceLink');
            if (quizLink) {
                quizLink.href = `${QUIZ_SERVICE_URL}/explore.html?sso_token=${encodeURIComponent(token)}&sso_user=${encodedUser}`;
            }
            
            // ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë§í¬ë“¤ë„ ë™ì¼í•˜ê²Œ ì„¤ì • ê°€ëŠ¥
            const service2Link = document.getElementById('service2Link');
            if (service2Link) {
                service2Link.href = `http://localhost:3003?sso_token=${encodeURIComponent(token)}&sso_user=${encodedUser}`;
            }
            
            const service3Link = document.getElementById('service3Link');
            if (service3Link) {
                service3Link.href = `http://localhost:3004?sso_token=${encodeURIComponent(token)}&sso_user=${encodedUser}`;
            }
        }
        
        function updateActiveSessions() {
            const sessions = [];
            
            // Check for tokens in localStorage
            if (localStorage.getItem(config.sso.tokenKey)) {
                sessions.push({
                    service: 'Auth Server',
                    status: 'Active',
                    time: new Date().toLocaleTimeString('ko-KR')
                });
            }
            
            const sessionsHtml = sessions.map(s => `
                <div style="background: #F3F4F6; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
                    <strong>${s.service}</strong> - ${s.status}
                    <br><small style="color: #6B7280;">${s.time}</small>
                </div>
            `).join('');
            
            document.getElementById('activeSessions').innerHTML = sessionsHtml || '<p style="color: #6B7280; font-size: 14px;">í™œì„± ì„¸ì…˜ ì—†ìŒ</p>';
        }
        
        // Logout handlers
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await supabase.auth.signOut();
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
        
        document.getElementById('logoutAllBtn').addEventListener('click', async () => {
            if (confirm('ëª¨ë“  ê¸°ê¸°ì—ì„œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await supabase.auth.signOut({ scope: 'global' });
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Global logout error:', error);
                    alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });
        
        // Initialize
        checkAuth();
    </script>
</body>
</html>